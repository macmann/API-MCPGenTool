<%
  const escapeHtml = (value) => String(value ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

  const keyQuery = query.key ? `?key=${encodeURIComponent(query.key)}` : '';
  const varsRows = (vars || []).map((row) => `
    <tr>
      <td><code>${escapeHtml(row.k)}</code></td>
      <td>${escapeHtml(row.v)}</td>
      <td class="right">
        <form method="post" action="/admin/${encodeURIComponent(e.id)}/vars/delete${keyQuery}" onsubmit="return confirm('Delete variable?');" style="display:inline-flex; gap: 0.5rem; align-items: center;">
          <input type="hidden" name="k" value="${escapeHtml(row.k)}" />
          <button class="contrast" type="submit">Delete</button>
        </form>
      </td>
    </tr>
  `).join('');

  const body = `
    <section>
      <header class="flex" style="justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
        <div>
          <h2 style="margin-bottom: 0.25rem;">Variables for <code>${escapeHtml(e.method)} ${escapeHtml(e.path)}</code></h2>
          <p class="muted" style="margin: 0;">Reference these in responses with <code>{{vars.KEY}}</code>.</p>
        </div>
        <a class="secondary" href="/admin/${encodeURIComponent(e.id)}${keyQuery}">Back to endpoint</a>
      </header>
      <table>
        <thead>
          <tr><th>Key</th><th>Value</th><th></th></tr>
        </thead>
        <tbody>
          ${varsRows || `<tr><td colspan="3" class="muted">No variables yet.</td></tr>`}
        </tbody>
      </table>
      <form method="post" action="/admin/${encodeURIComponent(e.id)}/vars/save${keyQuery}" class="grid" style="margin-top: 1.5rem; gap: 1rem;">
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem;">
          <label>Key<input name="k" placeholder="price" required /></label>
          <label>Value<input name="v" placeholder="199.00" required /></label>
        </div>
        <button type="submit" class="button primary">Save Variable</button>
      </form>
    </section>
  `;
%>
<%- include('layout', { title: `Variables Â· ${e.method} ${e.path}`, body }) %>
